<p>Statistics for #ntnugangstaz @ EFNet was generated on <%= Time.now %>. Stats have been generated for <%= time_ago_in_words(Log.first.created_at) %>, and in that period a total of <%= @nicks.size %> nicks have been active and <%= Log.count %> lines have been written.</p>
<h2>Highscore</h2>
<div id="highscore">
  <table>
    <th>Place</th>
    <th>Nick</th>
    <th>Percentage</th>
    <th>Lines</th>
    <th>Words</th>
    <th>First Seen</th>
    <th>Last Seen</th>
    <% count = 1 %>
    <% @sorted_g_logs.each do |t| %>
      <% if t.nick != nil %>
        <tr>
          <td><%= count %></td>
          <td><%= t.nick.nick %></td>
          <td><%= sprintf("%.1f",((t.count.to_f / @total_count.to_f) * 100)) %>%</td>
          <td><%= t.count %></td>
          <td><%= t.nick.words %></td>
          <td><%= time_ago_in_words(t.nick.created_at) %> ago</td>
          <td><%= time_ago_in_words(t.nick.updated_at) %> ago</td>
        </tr>
        <% count += 1 %>
      <% end %>
    <%end%>
  </table>
</div>

<!-- CHARTS -->
<h2>Charts (more to come)</h2>
<div id="charts">
  <script type="text/javascript"> 

    var chart;
    $(document).ready(function() {
        chart = new Highcharts.Chart({
          chart: {
            renderTo: 'cake',
            plotBackgroundColor: null,
            plotBorderWidth: null,
            plotShadow: false
          },
          title: {
            text: 'Top 5 all time'
          },
          tooltip: {
            formatter: function() {
              return '<b>'+ this.point.name +'</b>: '+ this.y +' %';
            }
          },
          plotOptions: {
            pie: {
              allowPointSelect: true,
              cursor: 'pointer',
              dataLabels: {
                enabled: false
              },
              showInLegend: true
            }
          },
          series: [{
            type: 'pie',
            name: 'User share',
            data: [
              <% count = 1 %>
              <% total_percentage = 0 %>
              <% @sorted_g_logs.each do |t| %>
                ['<%= t.nick.nick %>',<%= percentage = sprintf("%.1f",((t.count.to_f / @total_count.to_f) * 100)) %>], 
                <% total_percentage += percentage.to_f %>
                <% break if count > 4 %>
                <% count += 1 %>
              <% end %>
              ['Others',   <%= 100.0 - total_percentage %>]
            ]
          }]
        });
      });
</script>                                         
<!-- top 5 last month -->
  <script type="text/javascript"> 

    var chart;
    $(document).ready(function() {
        chart = new Highcharts.Chart({
          chart: {
            renderTo: 'cake_month',
            plotBackgroundColor: null,
            plotBorderWidth: null,
            plotShadow: false
          },
          title: {
            text: 'Top 5 last 30 days'
          },
          tooltip: {
            formatter: function() {
              return '<b>'+ this.point.name +'</b>: '+ this.y +' %';
            }
          },
          plotOptions: {
            pie: {
              allowPointSelect: true,
              cursor: 'pointer',
              dataLabels: {
                enabled: false
              },
              showInLegend: true
            }
          },
          series: [{
            type: 'pie',
            name: 'User share',
            data: [
              <% count = 1 %>
              <% total_percentage = 0 %>
              <% @sorted_g_logs.where("created_at > '#{30.days.ago}'").each do |t| %>
                ['<%= t.nick.nick %>',<%= percentage = sprintf("%.1f",((t.count.to_f / Log.where("created_at > '#{30.days.ago}'").count.to_f) * 100)) %>], 
                <% total_percentage += percentage.to_f %>
                <% break if count > 4 %>
                <% count += 1 %>
              <% end %>
              ['Others',   <%= 100.0 - total_percentage %>]
            ]
          }]
        });
      });
</script>                                         


<!-- number of lines per month -->
<% log_months = Log.hash_by_month %>
<script type="text/javascript">
  var chart;
  $(document).ready(function() {
    chart = new Highcharts.Chart({
      chart: {
        renderTo: 'plot',
        defailtSeriesType: 'line',
        //marginRight: 130,
        marginBottom: 25
      },
      title: {
        text: '# lines per month',
        x: -20
      },
      xAxis: {
        <% count = 0 %>
        categories: [
        <% log_months.each do |k,v| %>
          <% count += 1 %>
          <%= count < log_months.size ? "'#{k}', ":"'#{k}'" %>
        <% end %>
        ]
      },
      yAxis: {
        title: {
          text: '# lines'
        },
        plotLines: [{
          value: 0,
          width: 1,
          color: '#808080'
        }]
      },
      series: [{
        name: 'ntnugangstaz',
        <% count = 0 %>
        data: [
        <% log_months.each do |k,v| %>
          <% count += 1 %>
          <%= count < log_months.size ? "#{v}, ":"'#{v}'" %>
        <% end %>
        ]
      }]
    });
  });
</script>




<!-- chart divs -->
<div id="cake" style="width: 80%; height: 400px;"></div>
<div id="cake_month" style="width: 80%; height: 400px;"></div>
<div id="plot" style="width: 80%; height: 400px;"></div>
</div>
<!-- GENERAL -->
<% count = 0 %>
<div id="general">
  <h2>General stats</h2>
  <table>
    <tr>
      <td>Number of users</td><td><%= @nicks.size %></td>
    </tr>
    <tr>
      <td>Users active in the last 30 days</td><td><%= Nick.active_last(30.days)  %></td>
    </tr>
    <tr>
      <td>Number of lines</td><td><%= Log.count %></td>
    </tr>
    <tr>
      <td>Number of questions asked to gangbot</td><td><%= EightballLog.count %></td>
      <tr>
        <td>% of lines by top 5 nicks</td><td><% for t in 0..5 %><% count += @sorted_g_logs[t].count.to_i %><%end%><%= sprintf("%.1f",((count.to_f / @total_count.to_f) * 100)) %>%</td>
      </tr>
    </table>
  </div>
  <div id="funsies">
    <h2>Funsies</h2>
    <% random_log = Log.random %>
    <p>Quote of the now: &lsaquo;<%=h random_log.nick.nick %>&rsaquo; <%=h random_log.text %><br>
    </p>
    <div id="links">
      <h2>Last <%= @links.all.size %> links posted</h2>
      <table>
        <th>Link</th>
        <th>Original poster</th>
        <th>First posted</th>
        <% @links.each do |l| %>
          <tr>
            <td class="maxlength"><%= link_to l.link, l.link %></td>
            <td><%=h l.nick.nick %></td>
            <td><%=h l.created_at.strftime("%c") %></td>
          </tr>
        <%end%>
      </table>
    </div>
    <div id="8balls">
      <h2>Last <%= @eightball_limit.all.size %> questions asked to gangbot</h2>
      <table>
        <th>Asked by</th>
        <th>Question</th>
        <th>Answer</th>
        <th>Time since</th>
        <% @eightball_limit.each do |e| %>
          <tr>
            <td><%=h e.nick.nick %></td>
            <td><%=h e.query %></td>
            <td><%=h e.answer %></td>
            <td><%=h time_ago_in_words(Time.parse(e.created_at.to_s)) %></td>
          </tr>
        <%end%>
      </table>
    </div>
    <p>Time taken to render page <%= Time.now - @time_taken %></p>
